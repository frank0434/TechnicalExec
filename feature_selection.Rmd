---
title: "Untitled"
author: "Jian(Frank)"
date: "27/01/2022"
output: slidy_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
options(scipen=999)
source("scripts/pkgs.R")
source("scripts/functions.R")
```

## R Markdown

This is an R Markdown presentation. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.

## Slide with Bullets

- Bullet 1
- Bullet 2
- Bullet 3

## Slide with R Output

```{r read data, echo = TRUE}
data <- fread("Data/BigMart.csv")
# clean data
data[, Item_Fat_Content:=ifelse(Item_Fat_Content %in% c("low fat", "LF", "Low Fat"),
                                "Low Fat", 
                                ifelse(Item_Fat_Content == "reg", "Regular", Item_Fat_Content))]
str(data)

summary(data)

ggpairs(data[,.(Item_Fat_Content, Item_Outlet_Sales)], 
        upper = list(continuous = wrap("cor", size = 2.5)), cardinality_threshold = 17)
```

# Goals:
-	Build a model to predict the number of sales (Item_Outlet_Sales) using the available features.
-	Gain insights about the number of sales.

-	Pretend you are presenting the results to an executive level manager of one of our clients.


iteam weight has more than 1400 NAs
Could be leave out first 

item_outlet_sales ~ f(x)

```{r}
cate_cols <- sapply(data, function(x) {
  x <- ifelse(is.character(x), 1, 0)
  x
  })
colnames(data)
catecols_pos <- names(which(cate_cols == 1))
cate_data <- data[,..catecols_pos]
cate_data

apply(cate_data[, Item_Identifier := NULL], 2, unique)
```


## The top 10 popular Product
```{r}
product_type <- data[, sum(Item_Outlet_Sales), 
                     by = .(Item_Type, Item_Fat_Content, Item_Identifier)
                     ][1:30]
product_type$Item_Type %>% 
  unique()
product_type %>% 
  ggplot(aes(fct_reorder(Item_Identifier, V1),V1, color = Item_Fat_Content, shape = Item_Type))+
  geom_point()+
  coord_flip() +
  labs(title = "Top 30 Best Selling Products", 
       y = "",x = "") +
  theme_minimal()+
  theme( title = element_text(size = 18, face = "bold"),
         axis.text = element_text(size = 13),
         axis.title = element_text(size = 9, vjust =  "rt"),
         plot.margin = margin(30, 30, 30, 30), 
         panel.spacing =  grid::unit(2, "lines"))+
  scale_y_comma(limits=c(0,50000)) +
  geom_text(aes(label=scales::comma(V1)), hjust=0, nudge_y=500) 

product_type[,.N, by =.(Item_Fat_Content)]
product_type[Item_Fat_Content == "Regular"]$Item_Identifier
product_type[(Item_Fat_Content == "Regular") &
               (!Item_Type %like% "Fruits and ")][order(V1,decreasing = TRUE)]

```

low fat products are popular. 
In the top 30 selling products, top 3 are low fat products. 
16 out of 30 are still regular products (2 products are fruit and vegetables).
Provide alternative low fat products for the rest of 14 regular products may boost sales?

## The most popular Product Type


```{r, fig.width=9}
product_type <- data[, sum(Item_Outlet_Sales), by = .(Item_Type, Item_Fat_Content)
                     ][, total := sum(V1), by = .(Item_Type)
                       ][, pct := round(V1/total, digits = 2)]
sales_rank <- data[, sum(Item_Outlet_Sales), by =.(Item_Type)
                   ][order(V1, decreasing = TRUE)]
product_type <- product_type[sales_rank, on = "Item_Type"]

product_type$Item_Type <- factor(product_type$Item_Type, levels = rev(sales_rank$Item_Type))
product_type %>% 
  ggplot(aes(Item_Type,V1, fill = Item_Fat_Content))+
  geom_bar(stat = "identity", position = "stack")+
  coord_flip() +
  labs(title = "Overall Best Selling Product Types", 
       y = "",x = "") +
  theme_minimal()+
  theme( title = element_text(size = 18, face = "bold"),
         axis.text = element_text(size = 13),
         axis.title = element_text(size = 9, vjust =  "rt"),
         plot.margin = margin(30, 30, 30, 30), 
         panel.spacing =  grid::unit(2, "lines"),
         legend.position = "bottom")+
  scale_y_comma(limits=c(0,3500000)) +
  scale_fill_manual(name = "Fat Content", 
                    values =  corporate_colors[1:2],
                    guide = guide_legend(reverse = TRUE)) +
  geom_text(aes(y = i.V1 + 200000 , label= scales::comma(i.V1)))


```


## The most popular store 

```{r, fig.width=9}
popular_store <- data[, sum(Item_Outlet_Sales), by = .(Outlet_Type, Outlet_Identifier)]
popular_store  %>% 
  ggplot(aes(fct_reorder(Outlet_Identifier, V1),V1, fill = Outlet_Type))+
  geom_col()+
  coord_flip() +
  labs(title = "The Most Popular Store", 
       y = "",x = "") +
  min_theme()+
  scale_y_comma(limits=c(0,4000000)) +
  scale_fill_manual(name = "Outlet Type", values = corporate_colors,
                    guide = guide_legend(reverse = TRUE)) +
  geom_text(aes(label=scales::comma(V1)), hjust=0, nudge_y=5000) 
```
## Why store 10 and 19 are so small on sales? 
```{r}
data[Outlet_Type %like% 3 ]
data[Outlet_Identifier %in% c("OUT010", "OUT019")]$Outlet_Type %>% unique()

unique(data[,.(Outlet_Identifier, Outlet_Establishment_Year, Outlet_Type, 
               Outlet_Location_Type = as.character(Outlet_Location_Type))]) %>% 
  ggplot(aes(forcats::fct_reorder(Outlet_Identifier, Outlet_Establishment_Year, .desc = TRUE),
             Outlet_Establishment_Year, color = Outlet_Type, shape = Outlet_Location_Type)) +
  geom_point(size = 3)+
  coord_flip() +
  scale_y_continuous(position = "right") +
  min_theme() +
  labs(x = "Outlet Identifier", 
       y = "Establishment Year") +
  scale_color_manual(name = "Outlet Type", values = corporate_colors,
                    guide = guide_legend(reverse = TRUE))
  
```
OUT010 and 019 are Grocery Stores 

## Does Location affect sales?
```{r}

popular_store <- data[, sum(Item_Outlet_Sales), by = .(Outlet_Location_Type)]
popular_store[, Outlet_Location_Type := as.character(Outlet_Location_Type)]  %>% 
  ggplot(aes(fct_reorder(Outlet_Location_Type, V1),V1, fill = Outlet_Location_Type))+
  geom_col()+
  coord_flip() +
  labs(title = "The Most Popular Store", 
       y = "",x = "") +
  min_theme()+
  scale_y_comma(limits=c(0,8000000)) +
  scale_fill_manual(name = "Outlet  Location Type", values = corporate_colors,
                    guide = guide_legend(reverse = TRUE)) +
  geom_text(aes(label=scales::comma(V1)), hjust=0, nudge_y=5000) 


data[, .(Item_Outlet_Sales,Outlet_Location_Type)] %>% 
  ggplot(aes(Outlet_Location_Type, Item_Outlet_Sales, group = Outlet_Location_Type))+
    geom_jitter(alpha = .3)+
  geom_boxplot()


```
The **long tail* created the skewness, what are these? 

```{r, fig.height= 10, fig.width= 8}
outliner_items <- data[Item_Outlet_Sales > 5000]

outliner_items %>% 
  ggplot(aes( Item_MRP, Item_Outlet_Sales, color = Item_Visibility)) +
  geom_point() +
  facet_grid(  Item_Fat_Content + Item_Type ~ Outlet_Size + Outlet_Type + Outlet_Identifier)
```



```{r}
cat_cols <- which(sapply(data, is.character) == 1)

unique(data[, ..cat_cols])

data %>% 
  ggplot(aes(Item_MRP, Item_Outlet_Sales, color = Item_Type)) +
  geom_jitter(alpha = 0.8) +
  facet_wrap(~ Item_Fat_Content)
```



## Fat content matters?

```{r, fig.width=9}
product_type <- data[, sum(Item_Outlet_Sales), by = .(Item_Fat_Content)]
product_type %>% 
  ggplot(aes(Item_Fat_Content,V1))+
  geom_col(fill = corporate_colors[2])+
  # coord_flip() +
  labs(title = "Product Fat Content in relation to total sells", 
       y = "",x = "") +
  theme_minimal()+
  theme( title = element_text(size = 18, face = "bold"),
         axis.text = element_text(size = 13),
         axis.title = element_text(size = 9, vjust =  "rt"),
         plot.margin = margin(30, 30, 30, 30), 
         panel.spacing =  grid::unit(2, "lines"))+
  scale_y_comma(limits=c(0,15500000)) +
  geom_text(aes(label=scales::comma(V1)), size= 8, nudge_y=1500000) 
```


## The most popular Top selling stores, items


```{r}
data[,]
```


```{r}
data%>% 
  ggplot(aes(log(Item_Outlet_Sales)))+
  geom_histogram()

data[Item_Outlet_Sales > 10000]


for(i in catecols_pos[-1]){
  key <- i
  
  sums <- data[, .(topsales = sum(Item_Outlet_Sales, na.rm = TRUE)), 
               by = key
               ][order(topsales, decreasing = TRUE)] 
  p <- sums %>% 
    ggplot(aes(forcats::fct_reorder(sums[[key]], topsales), topsales)) +
    geom_col() +
    coord_flip()
  print(p)
}
data[Item_Outlet_Sales < 100]
```

```{r}
library(Boruta)
boruta_output <- Boruta(Item_Outlet_Sales ~ ., data=na.omit(data[, Item_Identifier :=NULL]), doTrace=0)  
names(boruta_output)
boruta_output$finalDecision
boruta_signif <- getSelectedAttributes(boruta_output, withTentative = TRUE)
print(boruta_signif)  
roughFixMod <- TentativeRoughFix(boruta_output)
boruta_signif <- getSelectedAttributes(roughFixMod)
imps <- attStats(roughFixMod)
imps2 = imps[imps$decision != 'Rejected', c('meanImp', 'decision')]
head(imps2[order(-imps2$meanImp), ])  # descending sort
plot(boruta_output, cex.axis=.7, las=2, xlab="", main="Variable Importance")  

decision <- as.character(boruta_output$finalDecision)
names(boruta_output$finalDecision) <- decision 

str(boruta_output)
names(boruta_output$finalDecision)

```

```{r}
data %>% 
  ggplot(aes(Item_MRP, fill = Item_Type))+
  geom_histogram(binwidth = 1)
data %>% 
  ggplot(aes(Item_MRP, fill = Item_Type))+
  geom_histogram(binwidth = 1)

data %>% 
  ggplot(aes(Item_MRP, fill = Outlet_Type))+
  geom_histogram(binwidth = 1)

data %>% 
  ggplot(aes(Item_MRP, fill = Outlet_Size))+
  geom_histogram(binwidth = 1)

data %>% 
  ggplot(aes(Item_MRP, fill = Outlet_Identifier))+
  geom_histogram(binwidth = 1)

```

```{r}
data%>% 
  ggplot(aes(Item_MRP, log10(Item_Outlet_Sales), color = Item_Visibility)) +
  geom_point()+
  geom_smooth(method = "loess", span = 0.5)
data%>% 
  ggplot(aes(Item_MRP, log10(Item_Outlet_Sales), color = Item_Fat_Content)) +
  geom_point()+
  geom_smooth(method = "loess", span = 0.5)
data%>% 
  ggplot(aes(Item_MRP, log10(Item_Outlet_Sales), color = Outlet_Identifier)) +
  geom_point()+
  geom_smooth(method = "loess", span = 0.5)
data%>% 
  ggplot(aes(Item_MRP, log10(Item_Outlet_Sales), color = Outlet_Size)) +
  geom_point()+
  geom_smooth(method = "loess", span = 0.5)

data%>% 
  ggplot(aes(Item_MRP, log10(Item_Outlet_Sales), color = Outlet_Establishment_Year)) +
  geom_point()+
  geom_smooth(method = "loess", span = 0.5)

data%>% 
  ggplot(aes(Item_MRP, log10(Item_Outlet_Sales), color = Item_Type)) +
  geom_point()+
  geom_smooth(method = "loess", span = 0.5)

data%>% 
  ggplot(aes(Item_MRP, log10(Item_Outlet_Sales))) +
  geom_boxplot()
  # geom_smooth(method = "loess", span = 0.5)
```

## select method for feature selection

```{r}
library(caret)
set.seed(42)
rpart <- train(Item_Outlet_Sales ~ ., data=na.omit(data), method = "rpart")
rpartimp <- varImp(rpart)

rpartimp
```

```{r}
data %>% 
  ggplot(aes(Outlet_Establishment_Year, log(Item_Outlet_Sales), group = Outlet_Establishment_Year)) +
  geom_boxplot()
data %>% 
  ggplot(aes(Outlet_Establishment_Year, Item_Outlet_Sales, group = Outlet_Establishment_Year)) +
  geom_boxplot()

```
## Regularized Random Forest (RRF) algorithm.
```{r}
set.seed(42)
rrfMod <- train(Item_Outlet_Sales ~ ., data=na.omit(data), method = "rpart")
rrfImp <- varImp(rrfMod, scale=F)
rrfImp

```
## L1

```{r}
library(glmnet)
library(vtreat) # convert categorical variables 
trainData <- read.csv("Data/BigMart.csv")[-1]
trainData$Item_Outlet_Sales <- log(trainData$Item_Outlet_Sales)
transform_design <- vtreat::NumericOutcomeTreatment(
    var_list = setdiff(colnames(trainData), c('Item_Outlet_Sales')),  # columns to transform
    outcome_name = 'Item_Outlet_Sales'                        # outcome variable
)

# the unpack notation is a multiassignment operator
# see https://winvector.github.io/wrapr/articles/unpack_multiple_assignment.html
# for more details
library(wrapr)
tf  <- vtreat::fit_prepare(transform_design, trainData)

treatment_plan <- tf$treatments
d_prepared <- tf$cross_frame


# get statistics on the variables
score_frame <- get_score_frame(treatment_plan)
score_frame[score_frame[['recommended']], 'varName', drop = FALSE]


d_prepared['Item_Outlet_Sales_centered'] <- d_prepared$Item_Outlet_Sales - mean(d_prepared$Item_Outlet_Sales)

WVPlots::ScatterHist(
  d_prepared, 
  xvar = 'Item_Identifier_catN',
  yvar = 'Item_Outlet_Sales_centered',
  smoothmethod = 'identity',
  estimate_sig = TRUE,
  title = 'Relationship between xc_catN and y')

score_frame[score_frame$varName == 'Item_Identifier_catN', ]$rsq

model_vars <- score_frame$varName[score_frame$recommended]
# to use all the variables:
# model_vars <- score_frame$varName

f <- wrapr::mk_formula('Item_Outlet_Sales', model_vars)

model = lm(f, data = d_prepared)

# now predict
d_prepared['prediction'] = predict(
  model,
  newdata = d_prepared)

# look at the fit (on the training data)
WVPlots::ScatterHist(
  d_prepared, 
  xvar = 'prediction',
  yvar = 'Item_Outlet_Sales',
  smoothmethod = 'identity',
  estimate_sig = TRUE,
  title = 'Relationship between prediction and Item_Outlet_Sales')



x <- as.matrix(d_prepared[,-(58:60)]) # all X vars
y <- log(trainData$Item_Outlet_Sales) # Only Class

# Fit the LASSO model (Lasso: Alpha = 1)
set.seed(42)
cv.lasso <- cv.glmnet(x, y, alpha=1, parallel=TRUE, standardize=TRUE, type.measure='auc')

# Results
plot(cv.lasso)
cat('Min Lambda: ', cv.lasso$lambda.min, '\n 1Sd Lambda: ', cv.lasso$lambda.1se)
df_coef <- round(as.matrix(coef(cv.lasso, s=cv.lasso$lambda.min)), 2)

# See all contributing variables
df_coef[df_coef[, 1] != 0, ]
```
